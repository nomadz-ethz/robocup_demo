<!-- 正式比赛专用 -->

<root BTCPP_format="4">
    <include path="./subtrees/subtree_cam_find_and_track_ball.xml" />
    <include path="./subtrees/subtree_striker_play.xml" />
    <include path="./subtrees/subtree_goal_keeper_play.xml" />
    <include path="./subtrees/subtree_striker_freekick.xml" />
    <include path="./subtrees/subtree_goal_keeper_freekick.xml" />
    <include path="./subtrees/subtree_locate.xml" />
    <include path="./subtrees/subtree_auto_standup_and_locate.xml" />
    <BehaviorTree ID="MainTree">
        <Sequence name="root">
            <RunOnce><Script code="control_state=3" /></RunOnce>
            <ReactiveSequence _while="control_state==1 || assist_kick || go_manual || assist_chase" >
                <Speak text="manual" />
                <SimpleChase _while="assist_chase" vx_limit="1.5" vy_limit="0.1" stop_dist="0.0" stop_angle="0.3" />
                <Sequence _while="assist_kick">
                    <Kick speed_limit="0.9" min_msec_kick="1000"/>
               </Sequence>
            </ReactiveSequence>

            <ReactiveSequence _while="control_state==2" name="需要 pickup 时， 先走到进场位置， 然后按下 LT + A, 重新校准定位, 等待数秒后, 按 LT + B 继续比赛">
                <Speak text="locate" />
                <CamScanField  _while="!odom_calibrated"/>
                <SubTree ID="CamFindAndTrackBall" _autoremap="true" _while="odom_calibrated" />
                <SelfLocateEnterField />

            </ReactiveSequence>

            <ReactiveSequence _while="control_state==3 && (!go_manual)" name="包一层用于控制策略的开关, 3 为手柄 LT+B 的状态, 2 为 LT+A, 1 为 LT+X">
                <Speak text="auto" />
                <SubTree ID="AutoGetUpAndLocate" _autoremap="true" />
                <ReactiveSequence _while="gc_is_under_penalty" name="当前处于罚时状态, 或替补状态">
                    <SetVelocity />
                    <CamScanField  _while="!odom_calibrated"/>
                    <SubTree ID="CamFindAndTrackBall" _autoremap="true" _while="odom_calibrated" />
                    <SelfLocateEnterField />
                </ReactiveSequence>

                <ReactiveSequence _while="!gc_is_under_penalty" name="没有罚时, 正常比赛">
                    <ReactiveSequence _while="gc_game_sub_state_type=='TIMEOUT'" name="比赛暂停. 暂停时, game state 必为 INITIAL">
                        <SetVelocity />
                        <CamScanField _while="!odom_calibrated"/>
                        <SubTree ID="CamFindAndTrackBall" _autoremap="true" _while="odom_calibrated" />
                        <SelfLocateEnterField />
                    </ReactiveSequence>

                    <ReactiveSequence _while="gc_game_sub_state_type=='NONE'" name="正常比赛">
                        <ReactiveSequence _while="gc_game_state=='INITIAL'" name="在场外入场位置站好">
                            <CamScanField _while="!odom_calibrated"/>
                            <SubTree ID="CamFindAndTrackBall" _autoremap="true" _while="odom_calibrated" />
                            <SelfLocateEnterField />
                        </ReactiveSequence>

                        <ReactiveSequence _while="gc_game_state=='READY'" name="走到场内自己的起始位置">
                            <MoveHead pitch="0.35" yaw="0.0" />
                            <GoToReadyPosition  vx_limit="0.7" />
                            <SubTree ID="Locate" _autoremap="true" />
                        </ReactiveSequence>

                        <ReactiveSequence _while="gc_game_state=='SET'" name="站好等待比赛开始">
                            <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
                            <SetVelocity />
                            <SubTree ID="Locate" _autoremap="true" />
                        </ReactiveSequence>

                        <ReactiveSequence _while="gc_game_state=='PLAY'" name="比赛">
                            <SubTree ID="StrikerPlay" _autoremap="true" _while="player_role == 'striker'" />
                            <SubTree ID="GoalKeeperPlay" _autoremap="true" _while="player_role == 'goal_keeper'" />
                        </ReactiveSequence>

                        <ReactiveSequence _while="gc_game_state=='END'" name="比赛结束">
                            <SetVelocity />
                        </ReactiveSequence>

                    </ReactiveSequence>

                    <ReactiveSequence _while="gc_game_sub_state_type=='FREE_KICK' && gc_game_state=='PLAY'" name="开任意球">
                        <ReactiveSequence _while="gc_game_sub_state=='STOP'">
                            <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
                            <SubTree ID="Locate" _autoremap="true" _while="ball_location_known"/>
                            <SetVelocity />
                        </ReactiveSequence>
                        <ReactiveSequence _while="gc_game_sub_state=='GET_READY'">
                            <SubTree ID="Locate" _autoremap="true" _while="ball_location_known" />
                            <SubTree ID="StrikerFreekick" _autoremap="true" _while="player_role == 'striker'" />
                            <SubTree ID="GoalKeeperFreekick" _autoremap="true" _while="player_role == 'goal_keeper'"/>
                        </ReactiveSequence>
                        <ReactiveSequence _while="gc_game_sub_state=='SET'">
                            <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
                            <SubTree ID="Locate" _autoremap="true" _while="ball_location_known" />
                            <SetVelocity />
                        </ReactiveSequence>
                    </ReactiveSequence>

                </ReactiveSequence>
            </ReactiveSequence>
        </Sequence>
    </BehaviorTree>
</root>